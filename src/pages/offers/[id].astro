---
import Layout from '../../layouts/Layout.astro';
import { verifySession } from '../../lib/auth/middleware';
import { getAdminDb } from '../../lib/firebase/admin';
import { formatCurrency } from '../../lib/money';
import type { OfferItem } from '../../lib/money';

const { id } = Astro.params;
const user = await verifySession(Astro.cookies);

if (!id) {
  return Astro.redirect('/offers/new');
}

if (!user) {
  return Astro.redirect(`/offers/public/${id}`);
}

const db = await getAdminDb();
const offerDoc = await db.collection('offers').doc(id).get();

if (!offerDoc.exists) {
  return new Response('Offer not found', { status: 404 });
}

const offer = offerDoc.data()!;
const items = offer.items as OfferItem[];
const totals = offer.totals;

// Check if user created this offer (for MVP, allow all authenticated users)
// Uncomment to restrict to creator only:
// if (offer.createdBy.uid !== user.uid) {
//   return new Response('Unauthorized', { status: 403 });
// }

const createdAt = offer.createdAt?.toDate?.() || new Date(offer.createdAt);
const validUntil = new Date(createdAt);
validUntil.setDate(validUntil.getDate() + (offer.validityDays || 14));
---

<Layout title={`Offer ${id}`}>
  <div class="min-h-screen bg-gray-50">
    <div class="max-w-4xl mx-auto px-4 py-8">
      <div class="mb-6 flex justify-between items-center">
        <h1 class="text-3xl font-bold text-gray-900">Offer Details</h1>
        <div class="space-x-4">
          {user.role === 'admin' && (
            <a
              href="/admin"
              class="text-sm text-indigo-600 hover:text-indigo-700 font-medium"
            >
              Admin
            </a>
          )}
          <a
            href="/offers/new"
            class="text-sm text-gray-600 hover:text-gray-900"
          >
            New Offer
          </a>
          <a
            href="/profile"
            class="text-sm text-gray-600 hover:text-gray-900"
          >
            Profile
          </a>
          <a
            href="/logout"
            class="text-sm text-gray-600 hover:text-gray-900"
          >
            Logout
          </a>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-md p-8">
        <div class="mb-6">
          <div class="flex justify-between items-start mb-4">
            <div>
              <h2 class="text-2xl font-bold text-gray-900">Offer #{id.slice(0, 8)}</h2>
              <p class="text-sm text-gray-500 mt-1">
                Created: {createdAt.toLocaleDateString()}
              </p>
            </div>
            <button
              id="downloadPdf"
              data-offer-id={id}
              class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700"
            >
              Download PDF
            </button>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-6 mb-6">
          <div>
            <h3 class="text-sm font-medium text-gray-500 mb-1">Client</h3>
            <p class="text-lg font-semibold">{offer.clientName}</p>
            {offer.companyName && (
              <p class="text-sm text-gray-600">{offer.companyName}</p>
            )}
            {offer.email && (
              <p class="text-sm text-gray-600">{offer.email}</p>
            )}
          </div>
          <div>
            <h3 class="text-sm font-medium text-gray-500 mb-1">Validity</h3>
            <p class="text-sm text-gray-900">
              Valid until: {validUntil.toLocaleDateString()}
            </p>
            <p class="text-sm text-gray-500">
              ({offer.validityDays} days)
            </p>
          </div>
        </div>

        <div class="border-t pt-6 mb-6">
          <h3 class="text-lg font-semibold mb-4">Items</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    Category
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">
                    Item
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Qty
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Unit Price
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">
                    Total
                  </th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                {items.map((item, index) => (
                  <tr key={index}>
                    <td class="px-4 py-3 text-sm text-gray-900">{item.category}</td>
                    <td class="px-4 py-3">
                      <p class="text-sm font-medium text-gray-900">{item.label}</p>
                      <p class="text-xs text-gray-500">{offer.notes ?? item.description}</p>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">
                      {item.qty}
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 text-right">
                      {formatCurrency(item.unitPrice, offer.currency)}{(item.category === 'Local SEO' || item.category === 'Web SEO' || item.category === 'AI SEO' || item.category === 'Social Media') && item.itemId !== 'extra-video' && item.itemId !== 'extra-post' && item.itemId !== 'extra-hosting' && item.itemId !== 'extra-page' ? ' / μήνα' : ''}
                    </td>
                    <td class="px-4 py-3 text-sm font-semibold text-gray-900 text-right">
                      {formatCurrency(item.lineTotal, offer.currency)}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        <div class="border-t pt-6">
          <div class="flex justify-end">
            <div class="w-64 space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Subtotal:</span>
                <span class="text-gray-900">{formatCurrency(totals.subtotal, offer.currency)}</span>
              </div>
              {offer.discountPercent > 0 && (
                <div class="flex justify-between text-sm text-green-600">
                  <span>Discount ({offer.discountPercent}%):</span>
                  <span>-{formatCurrency(totals.discountAmount, offer.currency)}</span>
                </div>
              )}
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Taxable:</span>
                <span class="text-gray-900">{formatCurrency(totals.taxable, offer.currency)}</span>
              </div>
              {offer.vatPercent > 0 && (
                <div class="flex justify-between text-sm">
                  <span class="text-gray-600">VAT ({offer.vatPercent}%):</span>
                  <span class="text-gray-900">{formatCurrency(totals.vatAmount, offer.currency)}</span>
                </div>
              )}
              <div class="flex justify-between text-lg font-bold border-t pt-2">
                <span>Total:</span>
                <span>{formatCurrency(totals.total, offer.currency)}</span>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script set:html={`
    const downloadBtn = document.getElementById('downloadPdf');
    downloadBtn?.addEventListener('click', async () => {
      const offerId = downloadBtn?.getAttribute('data-offer-id');
      if (!offerId) {
        alert('Offer ID not found');
        return;
      }
      try {
        const response = await fetch('/api/pdf?offerId=' + encodeURIComponent(offerId), {
          method: 'POST',
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Failed to generate PDF' }));
          throw new Error(errorData.error || 'Failed to generate PDF');
        }

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'offer-' + offerId.slice(0, 8) + '.pdf';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } catch (error) {
        alert('Failed to download PDF: ' + error.message);
      }
    });
  `} />
</Layout>

---
import Layout from '../layouts/Layout.astro';
import { requireUser } from '../lib/auth/middleware';

const user = await requireUser(Astro.cookies);
---

<Layout title="Profile">
  <div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4">
      <div class="bg-white rounded-lg shadow-md p-8">
        <h1 class="text-2xl font-bold text-gray-900 mb-6">Προφίλ Χρήστη</h1>
        
        <form id="profileForm" class="space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="name" class="block text-sm font-medium text-gray-700 mb-2">
                Όνομα *
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>
            
            <div>
              <label for="surname" class="block text-sm font-medium text-gray-700 mb-2">
                Επώνυμο *
              </label>
              <input
                type="text"
                id="surname"
                name="surname"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>
          </div>

          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
              Email
            </label>
            <input
              type="email"
              id="email"
              name="email"
              disabled
              class="w-full px-4 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-500 cursor-not-allowed"
            />
            <p class="mt-1 text-xs text-gray-500">Το email δεν μπορεί να αλλάξει</p>
          </div>

          <div>
            <label for="company" class="block text-sm font-medium text-gray-700 mb-2">
              Εταιρεία
            </label>
            <input
              type="text"
              id="company"
              name="company"
              class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            />
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
                Τηλέφωνο
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                placeholder="π.χ. 2101234567"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>
            
            <div>
              <label for="extension" class="block text-sm font-medium text-gray-700 mb-2">
                Εσωτερικό
              </label>
              <input
                type="text"
                id="extension"
                name="extension"
                placeholder="π.χ. 123"
                class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
              />
            </div>
          </div>

          <div class="flex items-center justify-between pt-4 border-t">
            <a
              href="/offers/new"
              class="text-sm text-gray-600 hover:text-gray-900"
            >
              ← Επιστροφή
            </a>
            <button
              type="submit"
              class="px-6 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              Αποθήκευση
            </button>
          </div>
        </form>

        <div id="message" class="mt-4 hidden"></div>
      </div>
    </div>
  </div>

  <script>
    // Load profile data
    async function loadProfile() {
      try {
        const response = await fetch('/api/profile');
        if (!response.ok) {
          throw new Error('Failed to load profile');
        }
        
        const data = await response.json();
        if (data.success && data.profile) {
          const profile = data.profile;
          (document.getElementById('name') as HTMLInputElement).value = profile.name || '';
          (document.getElementById('surname') as HTMLInputElement).value = profile.surname || '';
          (document.getElementById('email') as HTMLInputElement).value = profile.email || '';
          (document.getElementById('company') as HTMLInputElement).value = profile.company || '';
          (document.getElementById('phone') as HTMLInputElement).value = profile.phone || '';
          (document.getElementById('extension') as HTMLInputElement).value = profile.extension || '';
        }
      } catch (error) {
        console.error('Error loading profile:', error);
        showMessage('Σφάλμα κατά τη φόρτωση του προφίλ', 'error');
      }
    }

    // Show message
    function showMessage(text: string, type: 'success' | 'error') {
      const messageEl = document.getElementById('message');
      if (!messageEl) return;
      
      messageEl.textContent = text;
      messageEl.className = `mt-4 p-4 rounded-md ${
        type === 'success'
          ? 'bg-green-50 text-green-800 border border-green-200'
          : 'bg-red-50 text-red-800 border border-red-200'
      }`;
      messageEl.classList.remove('hidden');
      
      setTimeout(() => {
        messageEl.classList.add('hidden');
      }, 5000);
    }

    // Handle form submission
    const form = document.getElementById('profileForm') as HTMLFormElement;
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const data = {
        name: formData.get('name'),
        surname: formData.get('surname'),
        company: formData.get('company'),
        phone: formData.get('phone'),
        extension: formData.get('extension'),
      };
      
      try {
        const response = await fetch('/api/profile', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Failed to update profile' }));
          throw new Error(errorData.error || 'Failed to update profile');
        }
        
        showMessage('Το προφίλ ενημερώθηκε επιτυχώς!', 'success');
      } catch (error) {
        console.error('Error updating profile:', error);
        showMessage('Σφάλμα κατά την ενημέρωση του προφίλ: ' + (error as Error).message, 'error');
      }
    });

    // Load profile on page load
    loadProfile();
  </script>
</Layout>
